# Лаба 2


Сервисы

1. db (PostgreSQL)

	•	Образ: postgres:15 — PostgreSQL версии 15.
	•	Перезапуск: restart: always — контейнер будет автоматически перезапускаться при сбоях.
	•	Переменные окружения:
	•	POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB задаются через переменные среды. Если переменные отсутствуют, используются значения по умолчанию: user, password, spicyragdb.
	•	Порты: 5434:5432 — порт PostgreSQL (5432) проброшен на порт 5434 на хосте.
	•	Томa:
	•	postgres_data:/var/lib/postgresql/data — хранение данных базы вне контейнера для их сохранности.
	•	./data:/docker-entrypoint-initdb.d — папка для скриптов инициализации базы данных.
	•	Сети: подключён к пользовательской сети network.
	•	Команда запуска:
	•	Устанавливается дополнительный модуль postgresql-15-pgvector перед запуском PostgreSQL через стандартный скрипт docker-entrypoint.sh.

2. elasticsearch

	•	Образ: docker.elastic.co/elasticsearch/elasticsearch:7.9.3 — Elasticsearch версии 7.9.3.
	•	Переменные окружения:
	•	discovery.type=single-node — режим работы в одиночной ноде (для разработки).
	•	ES_JAVA_OPTS=-Xms1g -Xmx1g — выделение 1 ГБ памяти для Java Heap.
	•	Порты:
	•	9200:9200 — основной HTTP API порт Elasticsearch.
	•	9300:9300 — порт для межнодового взаимодействия.
	•	Томa:
	•	es_data:/usr/share/elasticsearch/data — хранение данных Elasticsearch вне контейнера.
	•	Сети: подключён к пользовательской сети network.

3. interface

	•	Назначение: Основной backend, написанный на FastAPI и запущенный с помощью uvicorn.
	•	Сборка: Собирается из текущего контекста (build: .).
	•	Команда запуска:
	•	Ожидает доступности PostgreSQL (через pg_isready) и Elasticsearch (через curl) перед запуском.
	•	Запускает сервер uvicorn на 0.0.0.0:8000 с перезагрузкой кода (--reload).
	•	Порты: 8000:8000 — порт сервиса проброшен наружу.
	•	Зависимости:
	•	Запуск зависит от PostgreSQL (db).
	•	Томa:
	•	./interface:/app/interface — монтирует локальную папку для кода приложения.
	•	Сети: подключён к пользовательской сети network.
	•	Healthcheck: Проверяет доступность сервиса через HTTP-запрос к http://localhost:8000:
	•	Интервал: каждые 30 секунд.
	•	Тайм-аут: 10 секунд.
	•	Повторные попытки: 5 раз.

4. streamlit

	•	Назначение: Web-приложение для визуализации данных (Streamlit).
	•	Сборка: Собирается из текущего контекста (build: .).
	•	Команда запуска:
	•	Запускает Streamlit приложение (streamlit/app.py) на 0.0.0.0:8501.
	•	Порты: 8501:8501 — порт сервиса проброшен наружу.
	•	Зависимости:
	•	Запуск зависит от сервиса interface.
	•	Сети: подключён к пользовательской сети network.

Тома (Volumes)

	1.	postgres_data: Хранит данные PostgreSQL.
	2.	es_data: Хранит данные Elasticsearch.

Сети (Networks)

	1.	network: Общая сеть для взаимодействия всех сервисов.

Резюме

Этот docker-compose.yml файл представляет собой многоуровневую архитектуру для приложения, включающего:

	1.	PostgreSQL как базу данных с поддержкой pgvector для работы с векторными данными.
	2.	Elasticsearch для полнотекстового поиска.
	3.	FastAPI Backend (interface) для обработки запросов.
	4.	Streamlit для визуализации данных.

Каждый сервис изолирован, но взаимодействует через общую сеть. Конфигурация подходит для разработки, с настройками сохранения данных и автоматического перезапуска.



### Запуск
```bash
docker compose up -d
```


### Можно ли ограничивать ресурсы (например, память или CPU) для сервисов в docker-compose.yml? Если нет, то почему, если да, то как
Да, в docker-compose.yml можно ограничивать ресурсы для сервисов, ram, cpu для каждого сервиса. Пример:
```
services:
  interface:
    ...
    deploy:
      resources:
        limits: - максимальные лимиты
          memory: 2048M
          cpus: 4
        reservations: - сколько ресурсов минимально надо использовать
          memory: 512M
          cpus: 1
```

### Как можно запустить только определенный сервис из docker-compose.yml, не запуская остальные?
```bash
docker compose up <service-name>
docker compose up db # пример
```
